# Firebase Authentication Implementation Guide

## Overview

Complete implementation of Firebase Authentication in React Native using Expo with custom config plugin approach. This guide covers the working solution that survives `expo prebuild` operations.

## Problem Statement

React Native Firebase integration with Expo prebuild workflow faces a critical issue:

- Manual Firebase configuration gets wiped out every time `expo prebuild --clean` runs
- `google-services.json` and Gradle configurations are lost
- App crashes with "No Firebase App '[DEFAULT]' has been created"

## Solution: Custom Expo Config Plugin

The **recommended approach** is using a custom Expo config plugin that automatically handles Firebase configuration during prebuild.

### Why This Approach Works

✅ **Survives `expo prebuild --clean`**  
✅ **Automatically copies `google-services.json`**  
✅ **Adds Google Services classpath and plugins**  
✅ **Works with React Native Firebase**  
✅ **CI-safe and team-safe**  
✅ **No manual Gradle editing required**

## Implementation Steps

### 1. Install Firebase Dependencies

```bash
npm install @react-native-firebase/app @react-native-firebase/auth @react-native-firebase/firestore
```

### 2. Firebase Project Setup

1. Create Firebase project at https://console.firebase.google.com
2. Add Android app with package name (e.g., `com.c12.dev`)
3. Download `google-services.json`
4. Enable Authentication → Email/Password
5. Enable Firestore Database (test mode)

### 3. Create Custom Config Plugin

Create `plugins/withFirebaseAndroid.js`:

```javascript
const {
  withAppBuildGradle,
  withProjectBuildGradle,
  withDangerousMod,
} = require('@expo/config-plugins');
const fs = require('fs');
const path = require('path');

module.exports = function withFirebaseAndroid(config) {
  // 1️⃣ Copy google-services.json
  config = withDangerousMod(config, [
    'android',
    async config => {
      const src = path.resolve(
        config.modRequest.projectRoot,
        'google-services.json'
      );
      const dest = path.resolve(
        config.modRequest.platformProjectRoot,
        'app/google-services.json'
      );

      if (fs.existsSync(src)) {
        fs.copyFileSync(src, dest);
        console.log('✅ Copied google-services.json');
      } else {
        console.warn('⚠️ google-services.json not found in project root');
      }

      return config;
    },
  ]);

  // 2️⃣ Add classpath
  config = withProjectBuildGradle(config, config => {
    if (!config.modResults.contents.includes('google-services')) {
      config.modResults.contents = config.modResults.contents.replace(
        /dependencies\s*{/,
        `dependencies {
        classpath 'com.google.gms:google-services:4.3.15'`
      );
      console.log('✅ Added Google Services classpath');
    }
    return config;
  });

  // 3️⃣ Apply plugin
  config = withAppBuildGradle(config, config => {
    if (
      !config.modResults.contents.includes('com.google.gms.google-services')
    ) {
      config.modResults.contents += `\napply plugin: 'com.google.gms.google-services'`;
      console.log('✅ Added Google Services plugin');
    }
    return config;
  });

  return config;
};
```

### 4. Register Plugin in App Config

Update `app.config.js`:

```javascript
export default {
  expo: {
    name: getAppName(),
    slug: 'c12',
    version: '1.0.0',

    plugins: ['./plugins/withFirebaseAndroid'],

    android: {
      package: getPackageId(),
      googleServicesFile: './google-services.json',
      // ... other config
    },
    // ... rest of config
  },
};
```

### 5. Create Firebase Configuration

Create `src/config/firebase.ts`:

```typescript
export const firebaseConfig = {
  apiKey: 'your-api-key',
  authDomain: 'your-project.firebaseapp.com',
  projectId: 'your-project-id',
  storageBucket: 'your-project.firebasestorage.app',
  messagingSenderId: 'your-sender-id',
  appId: 'your-app-id',
};
```

**Extract values from `google-services.json`:**

- `apiKey` → `current_key`
- `authDomain` → `{project_id}.firebaseapp.com`
- `projectId` → `project_id`
- `storageBucket` → `storage_bucket`
- `messagingSenderId` → `project_number`
- `appId` → `mobilesdk_app_id`

### 6. Create Authentication Service

Create `src/services/AuthService.ts`:

```typescript
import auth from '@react-native-firebase/auth';
import firestore from '@react-native-firebase/firestore';

export interface UserData {
  firstName: string;
  lastName: string;
  phoneNumber: string;
  email: string;
  uid: string;
  createdAt: Date;
}

class AuthService {
  // Register user with email and password
  async registerUser(
    email: string,
    password: string,
    userData: Omit<UserData, 'uid' | 'createdAt'>
  ) {
    try {
      const userCredential = await auth().createUserWithEmailAndPassword(
        email,
        password
      );
      const user = userCredential.user;

      // Store additional user data in Firestore
      const userDoc: UserData = {
        ...userData,
        uid: user.uid,
        createdAt: new Date(),
      };

      await firestore().collection('users').doc(user.uid).set(userDoc);

      return { success: true, user: userDoc };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // Login user with email and password
  async loginUser(email: string, password: string) {
    try {
      const userCredential = await auth().signInWithEmailAndPassword(
        email,
        password
      );
      const user = userCredential.user;

      // Get user data from Firestore
      const userDoc = await firestore().collection('users').doc(user.uid).get();
      const userData = userDoc.data() as UserData;

      return { success: true, user: userData };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // Listen to auth state changes
  onAuthStateChanged(callback: (user: any) => void) {
    return auth().onAuthStateChanged(callback);
  }

  // Get current user
  getCurrentUser() {
    return auth().currentUser;
  }

  // Logout user
  async logoutUser() {
    try {
      await auth().signOut();
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
}

export default new AuthService();
```

### 7. Update Components

**Registration Component** (`src/components/Registration.tsx`):

- Add password field
- Integrate Firebase registration
- Add form validation
- Handle loading states

**Login Component** (`src/components/Login.tsx`):

- Email/password login form
- Firebase authentication
- Switch to registration option

**App Navigation** (`App.js`):

- Authentication state management
- Login/Registration switching
- Welcome screen after auth

### 8. Security Configuration

**Add to `.gitignore`:**

```
# Firebase configuration files (contain sensitive keys)
google-services.json
GoogleService-Info.plist
```

**Why exclude from git:**

- Contains sensitive API keys
- Different environments need different files
- Security best practice

## Usage Workflow

### Development Setup

```bash
# 1. Place google-services.json in project root
cp ~/Downloads/google-services.json ./google-services.json

# 2. Build with Firebase integration
npm run prebuild:dev
npm run run:dev
```

### Team Onboarding

Each developer needs to:

1. Download their own `google-services.json` from Firebase Console
2. Place it in project root (not committed to git)
3. Run `npm run prebuild:dev`

### Environment Management

For different environments:

- `google-services-dev.json` → Dev environment
- `google-services-staging.json` → Staging environment
- Copy appropriate file to `google-services.json` before prebuild

## Key Features Implemented

### Authentication Flow

1. **Splash Screen** → Initial loading
2. **Login/Registration** → User authentication
3. **Welcome Screen** → Post-authentication

### Firebase Integration

- **User Registration** with email/password
- **User Login** with Firebase Auth
- **User Data Storage** in Firestore
- **Authentication State Management**
- **Automatic session persistence**

### Form Features

- **Input Validation** (all fields required)
- **Loading States** during auth operations
- **Error Handling** with user-friendly alerts
- **Switch between Login/Registration**

## Benefits of This Approach

### Development Benefits

- **Zero manual Gradle configuration**
- **Survives all prebuild operations**
- **Consistent across team members**
- **CI/CD friendly**

### Security Benefits

- **Firebase credentials not in git**
- **Environment-specific configurations**
- **Proper error handling**
- **Secure authentication flow**

### Maintenance Benefits

- **Expo-managed Firebase setup**
- **No fragile manual edits**
- **Automatic plugin execution**
- **Future-proof with Expo updates**

## Troubleshooting

### Common Issues

**"No Firebase App created" Error:**

- Ensure `google-services.json` is in project root
- Run `npm run prebuild:dev` after adding the file
- Check plugin logs during prebuild

**Plugin Not Running:**

- Verify plugin path in `app.config.js`
- Check `plugins/withFirebaseAndroid.js` exists
- Ensure proper plugin syntax

**Authentication Errors:**

- Verify Firebase project configuration
- Check Email/Password is enabled in Firebase Console
- Ensure Firestore is created and accessible

### Verification Steps

1. Check `android/app/google-services.json` exists after prebuild
2. Verify Gradle files contain Google Services plugin
3. Test user registration creates Firestore document
4. Confirm authentication state persistence

## Alternative Approaches Considered

### ❌ Manual Configuration

- Gets wiped by `expo prebuild --clean`
- Fragile and error-prone
- Not team-friendly

### ❌ Expo Firebase Packages

- Deprecated (`expo-firebase-*`)
- No longer maintained
- Limited functionality

### ✅ Custom Config Plugin (Chosen)

- Officially supported Expo pattern
- Survives prebuild operations
- Full React Native Firebase compatibility
- Production-ready solution

This implementation provides a robust, maintainable Firebase Authentication system that integrates seamlessly with the Expo development workflow.
