# Firebase Authentication Implementation Guide

## Overview

Complete implementation of Firebase Authentication in React Native using Expo with custom config plugin approach. This guide covers the working solution that survives `expo prebuild` operations.

## Problem Statement

React Native Firebase integration with Expo prebuild workflow faces a critical issue:

- Manual Firebase configuration gets wiped out every time `expo prebuild --clean` runs
- `google-services.json` and Gradle configurations are lost
- App crashes with "No Firebase App '[DEFAULT]' has been created"

## Solution: Custom Expo Config Plugin

The **recommended approach** is using a custom Expo config plugin that automatically handles Firebase configuration during prebuild.

### Why This Approach Works

✅ **Survives `expo prebuild --clean`**  
✅ **Automatically copies `google-services.json`**  
✅ **Adds Google Services classpath and plugins**  
✅ **Works with React Native Firebase**  
✅ **CI-safe and team-safe**  
✅ **No manual Gradle editing required**

## Implementation Steps

### 1. Install Firebase Dependencies

```bash
npm install @react-native-firebase/app @react-native-firebase/auth @react-native-firebase/firestore
```

### 2. Firebase Project Setup

1. Create Firebase project at https://console.firebase.google.com
2. Add Android app with package name (e.g., `com.c12.dev`)
3. Download `google-services.json`
4. Enable Authentication → Email/Password
5. Enable Firestore Database (test mode)

### 3. Create Custom Config Plugin

Create `plugins/withFirebaseAndroid.js`:

```javascript
const {
  withAppBuildGradle,
  withProjectBuildGradle,
  withDangerousMod,
} = require('@expo/config-plugins');
const fs = require('fs');
const path = require('path');

module.exports = function withFirebaseAndroid(config) {
  // 1️⃣ Copy google-services.json
  config = withDangerousMod(config, [
    'android',
    async config => {
      const src = path.resolve(
        config.modRequest.projectRoot,
        'google-services.json'
      );
      const dest = path.resolve(
        config.modRequest.platformProjectRoot,
        'app/google-services.json'
      );

      if (fs.existsSync(src)) {
        fs.copyFileSync(src, dest);
        console.log('✅ Copied google-services.json');
      } else {
        console.warn('⚠️ google-services.json not found in project root');
      }

      return config;
    },
  ]);

  // 2️⃣ Add classpath
  config = withProjectBuildGradle(config, config => {
    if (!config.modResults.contents.includes('google-services')) {
      config.modResults.contents = config.modResults.contents.replace(
        /dependencies\s*{/,
        `dependencies {
        classpath 'com.google.gms:google-services:4.3.15'`
      );
      console.log('✅ Added Google Services classpath');
    }
    return config;
  });

  // 3️⃣ Apply plugin
  config = withAppBuildGradle(config, config => {
    if (
      !config.modResults.contents.includes('com.google.gms.google-services')
    ) {
      config.modResults.contents += `\napply plugin: 'com.google.gms.google-services'`;
      console.log('✅ Added Google Services plugin');
    }
    return config;
  });

  return config;
};
```

### 4. Register Plugin in App Config

Update `app.config.js`:

```javascript
export default {
  expo: {
    name: getAppName(),
    slug: 'c12',
    version: '1.0.0',

    plugins: ['./plugins/withFirebaseAndroid'],

    android: {
      package: getPackageId(),
      googleServicesFile: './google-services.json',
      // ... other config
    },
    // ... rest of config
  },
};
```

### 5. Create Firebase Configuration

Create `src/config/firebase.ts`:

```typescript
export const firebaseConfig = {
  apiKey: 'your-api-key',
  authDomain: 'your-project.firebaseapp.com',
  projectId: 'your-project-id',
  storageBucket: 'your-project.firebasestorage.app',
  messagingSenderId: 'your-sender-id',
  appId: 'your-app-id',
};
```

**Extract values from `google-services.json`:**

- `apiKey` → `current_key`
- `authDomain` → `{project_id}.firebaseapp.com`
- `projectId` → `project_id`
- `storageBucket` → `storage_bucket`
- `messagingSenderId` → `project_number`
- `appId` → `mobilesdk_app_id`

### 6. Create Authentication Service

Create `src/services/AuthService.ts`:

```typescript
import auth from '@react-native-firebase/auth';
import firestore from '@react-native-firebase/firestore';

export interface UserData {
  firstName: string;
  lastName: string;
  phoneNumber: string;
  email: string;
  uid: string;
  createdAt: Date;
}

class AuthService {
  // Register user with email and password
  async registerUser(
    email: string,
    password: string,
    userData: Omit<UserData, 'uid' | 'createdAt'>
  ) {
    try {
      const userCredential = await auth().createUserWithEmailAndPassword(
        email,
        password
      );
      const user = userCredential.user;

      // Store additional user data in Firestore
      const userDoc: UserData = {
        ...userData,
        uid: user.uid,
        createdAt: new Date(),
      };

      await firestore().collection('users').doc(user.uid).set(userDoc);

      return { success: true, user: userDoc };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // Login user with email and password
  async loginUser(email: string, password: string) {
    try {
      const userCredential = await auth().signInWithEmailAndPassword(
        email,
        password
      );
      const user = userCredential.user;

      // Get user data from Firestore
      const userDoc = await firestore().collection('users').doc(user.uid).get();
      const userData = userDoc.data() as UserData;

      return { success: true, user: userData };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // Listen to auth state changes
  onAuthStateChanged(callback: (user: any) => void) {
    return auth().onAuthStateChanged(callback);
  }

  // Get current user
  getCurrentUser() {
    return auth().currentUser;
  }

  // Logout user
  async logoutUser() {
    try {
      await auth().signOut();
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
}

export default new AuthService();
```

### 7. Update Components

**Registration Component** (`src/components/Registration.tsx`):

- Add password field
- Integrate Firebase registration
- Add form validation
- Handle loading states

**Login Component** (`src/components/Login.tsx`):

- Email/password login form
- Firebase authentication
- Switch to registration option

**App Navigation** (`App.js`):

- Authentication state management
- Login/Registration switching
- Welcome screen after auth

### 8. Security Configuration

**Add to `.gitignore`:**

```
# Firebase configuration files (contain sensitive keys)
google-services.json
GoogleService-Info.plist
```

**Why exclude from git:**

- Contains sensitive API keys
- Different environments need different files
- Security best practice

## Usage Workflow

### Development Setup

```bash
# 1. Place google-services.json in project root
cp ~/Downloads/google-services.json ./google-services.json

# 2. Build with Firebase integration
npm run prebuild:dev
npm run run:dev
```

### Team Onboarding

Each developer needs to:

1. Download their own `google-services.json` from Firebase Console
2. Place it in project root (not committed to git)
3. Run `npm run prebuild:dev`

### Environment Management

For different environments:

- `google-services-dev.json` → Dev environment
- `google-services-staging.json` → Staging environment
- Copy appropriate file to `google-services.json` before prebuild

## Key Features Implemented

### Authentication Flow

1. **Splash Screen** → Initial loading
2. **Login/Registration** → User authentication
3. **Welcome Screen** → Post-authentication

### Firebase Integration

- **User Registration** with email/password
- **User Login** with Firebase Auth
- **User Data Storage** in Firestore
- **Authentication State Management**
- **Automatic session persistence**

### Form Features

- **Input Validation** (all fields required)
- **Loading States** during auth operations
- **Error Handling** with user-friendly alerts
- **Switch between Login/Registration**

## Benefits of This Approach

### Development Benefits

- **Zero manual Gradle configuration**
- **Survives all prebuild operations**
- **Consistent across team members**
- **CI/CD friendly**

### Security Benefits

- **Firebase credentials not in git**
- **Environment-specific configurations**
- **Proper error handling**
- **Secure authentication flow**

### Maintenance Benefits

- **Expo-managed Firebase setup**
- **No fragile manual edits**
- **Automatic plugin execution**
- **Future-proof with Expo updates**

## Troubleshooting

### Common Issues

**"No Firebase App created" Error:**

- Ensure `google-services.json` is in project root
- Run `npm run prebuild:dev` after adding the file
- Check plugin logs during prebuild

**Plugin Not Running:**

- Verify plugin path in `app.config.js`
- Check `plugins/withFirebaseAndroid.js` exists
- Ensure proper plugin syntax

**Authentication Errors:**

- Verify Firebase project configuration
- Check Email/Password is enabled in Firebase Console
- Ensure Firestore is created and accessible

### Verification Steps

1. Check `android/app/google-services.json` exists after prebuild
2. Verify Gradle files contain Google Services plugin
3. Test user registration creates Firestore document
4. Confirm authentication state persistence

## Alternative Approaches Considered

### ❌ Manual Configuration

- Gets wiped by `expo prebuild --clean`
- Fragile and error-prone
- Not team-friendly

### ❌ Expo Firebase Packages

- Deprecated (`expo-firebase-*`)
- No longer maintained
- Limited functionality

### ✅ Custom Config Plugin (Chosen)

- Officially supported Expo pattern
- Survives prebuild operations
- Full React Native Firebase compatibility
- Production-ready solution

This implementation provides a robust, maintainable Firebase Authentication system that integrates seamlessly with the Expo development workflow.

## Google Sign-In Implementation

Complete implementation of Google Sign-In with Firebase Authentication for React Native Expo bare workflow.

### Prerequisites

- Firebase project configured with Authentication
- React Native Firebase Auth installed
- Expo bare workflow setup

### Step 1: Install Google Sign-In SDK

```bash
npm install @react-native-google-signin/google-signin@^16.1.1
```

### Step 2: Firebase Console Configuration

#### 2.1 Get SHA Fingerprints

```bash
cd android/app
keytool -list -v -keystore debug.keystore -alias androiddebugkey -storepass android -keypass android | grep -E "SHA1|SHA256"
```

Expected output:

```
SHA1: 5E:8F:16:06:2E:A3:CD:2C:4A:0D:54:78:76:BA:A6:F3:8C:AB:F6:25
SHA256: FA:C6:17:45:DC:09:03:78:6F:B9:ED:E6:2A:96:2B:39:9F:73:48:F0:BB:6F:89:9B:83:32:66:75:91:03:3B:9C
```

#### 2.2 Add Fingerprints to Firebase

1. Go to [Firebase Console](https://console.firebase.google.com)
2. Select your project
3. Go to Project Settings (gear icon)
4. Select your Android app
5. Scroll to "SHA certificate fingerprints"
6. Add **both** SHA-1 and SHA-256 fingerprints
7. Download updated `google-services.json`
8. Replace root `google-services.json` file

#### 2.3 Verify Configuration

Updated `google-services.json` should contain:

```json
{
  "client": [
    {
      "oauth_client": [
        {
          "client_id": "YOUR_WEB_CLIENT_ID.apps.googleusercontent.com",
          "client_type": 3
        }
      ]
    }
  ]
}
```

### Step 3: Create Google Auth Service

Create `src/services/GoogleAuthService.ts`:

```typescript
import {
  GoogleSignin,
  statusCodes,
} from '@react-native-google-signin/google-signin';
import auth from '@react-native-firebase/auth';
import firestore from '@react-native-firebase/firestore';
import { UserData } from '../types/User';

class GoogleAuthService {
  constructor() {
    this.configure();
  }

  configure() {
    GoogleSignin.configure({
      webClientId: 'YOUR_WEB_CLIENT_ID.apps.googleusercontent.com',
      offlineAccess: true,
      hostedDomain: '',
      forceCodeForRefreshToken: true,
    });
  }

  async signIn() {
    try {
      console.log('Starting Google Sign-In...');

      // Check Play Services
      await GoogleSignin.hasPlayServices({
        showPlayServicesUpdateDialog: true,
      });
      console.log('Play Services available');

      // Get user info from Google
      const userInfo = await GoogleSignin.signIn();
      console.log(
        'Google Sign-In response structure:',
        JSON.stringify(userInfo, null, 2)
      );
      console.log(
        'Google Sign-In successful:',
        userInfo.data?.user?.email || userInfo.user?.email
      );

      // Create Firebase credential
      const idToken = userInfo.data?.idToken || userInfo.idToken;
      const googleCredential = auth.GoogleAuthProvider.credential(idToken);
      console.log('Firebase credential created');

      // Sign in to Firebase
      const firebaseUserCredential =
        await auth().signInWithCredential(googleCredential);
      const firebaseUser = firebaseUserCredential.user;
      console.log('Firebase sign-in successful:', firebaseUser.uid);

      // Extract user profile details
      const userData: UserData = {
        firstName:
          userInfo.data?.user?.givenName || userInfo.user?.givenName || '',
        lastName:
          userInfo.data?.user?.familyName || userInfo.user?.familyName || '',
        email: userInfo.data?.user?.email || userInfo.user?.email || '',
        phoneNumber: '', // Google doesn't provide phone number by default
        uid: firebaseUser.uid,
        createdAt: new Date(),
      };

      // Save user data to Firestore
      await firestore()
        .collection('users')
        .doc(firebaseUser.uid)
        .set(userData, { merge: true });
      console.log('User data saved to Firestore');

      return {
        success: true,
        user: userData,
        accessToken: userInfo.data?.idToken || userInfo.idToken,
        userId: firebaseUser.uid,
      };
    } catch (error) {
      console.error('Google Sign-In error:', error);
      return this.handleError(error);
    }
  }

  async signOut() {
    try {
      await GoogleSignin.signOut();
      await auth().signOut();
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  async getCurrentUser() {
    try {
      const currentUser = await GoogleSignin.getCurrentUser();
      return { success: true, user: currentUser };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  private handleError(error: any) {
    // If error is empty object or null/undefined, treat as cancellation
    if (!error || Object.keys(error).length === 0) {
      return { success: false, cancelled: true };
    }

    return { success: false, error: error?.message || 'Google Sign-In failed' };
  }
}

export default new GoogleAuthService();
```

### Step 4: Update Auth Service for Logout

Update `src/services/AuthService.ts`:

```typescript
import auth from '@react-native-firebase/auth';
import firestore from '@react-native-firebase/firestore';
import { GoogleSignin } from '@react-native-google-signin/google-signin';

// ... existing code ...

async logoutUser() {
  try {
    await auth().signOut();

    // Also sign out from Google to allow account selection next time
    try {
      await GoogleSignin.signOut();
    } catch (googleError) {
      console.log('Google sign out error (user may not be signed in with Google):', googleError);
    }

    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
}
```

### Step 5: Update Login Component

Update `src/components/Login.tsx`:

```typescript
// Add import
import GoogleAuthService from '../services/GoogleAuthService';

// Add Google Sign-In handler
const handleGoogleSignIn = async () => {
  const result = await GoogleAuthService.signIn();
  if (result.success) {
    onLoginSuccess();
  } else if (!('cancelled' in result)) {
    // Only show error if it wasn't cancelled
    Alert.alert('Google Sign-In Failed', 'error' in result ? result.error : 'Unknown error');
  }
};

// Add Google Sign-In button in JSX
<TouchableOpacity style={styles.googleButton} onPress={handleGoogleSignIn}>
  <Text style={styles.googleButtonText}>Continue with Google</Text>
</TouchableOpacity>
```

### Step 6: Update Registration Component

Update `src/components/Registration.tsx`:

```typescript
// Add import
import GoogleAuthService from '../services/GoogleAuthService';

// Add Google Sign-In handler
const handleGoogleSignIn = async () => {
  const result = await GoogleAuthService.signIn();
  if (result.success) {
    // Google Sign-In successful, navigate to welcome screen
    onRegistrationComplete();
  } else if (!('cancelled' in result)) {
    // Only show error if it wasn't cancelled
    Alert.alert('Google Sign-In Failed', 'error' in result ? result.error : 'Unknown error');
  }
};

// Add Google Sign-In button in JSX
<TouchableOpacity style={styles.googleButton} onPress={handleGoogleSignIn}>
  <Text style={styles.googleButtonText}>Continue with Google</Text>
</TouchableOpacity>
```

### Step 7: Rebuild and Test

```bash
npm run prebuild:dev
npm run android
```

### Key Features Implemented

#### ✅ Automatic Account Creation

- Users don't need separate registration when using Google OAuth
- Firebase automatically creates user account with Google profile data

#### ✅ Account Selection on Re-login

- Proper Google Sign-Out on app logout
- Users can select different Google accounts on subsequent sign-ins

#### ✅ Silent Cancellation Handling

- No error messages when users cancel Google Sign-In
- Graceful handling of empty error objects

#### ✅ Robust Error Handling

- Proper Firebase credential creation
- Firestore user data persistence
- Safe property access for different SDK response formats

### Troubleshooting

#### DEVELOPER_ERROR

- Ensure both SHA-1 and SHA-256 fingerprints are added to Firebase
- Verify `google-services.json` contains `oauth_client` entries
- Check Web Client ID matches Firebase configuration

#### Response Structure Issues

- Code handles both `userInfo.data.user` and `userInfo.user` formats
- Fallback for different SDK versions

#### Cancellation Errors

- Empty error objects `{}` treated as user cancellation
- No error alerts shown for cancelled sign-ins

### Configuration Summary

1. **Firebase Console**: Add SHA fingerprints, download updated config
2. **Root Directory**: Replace `google-services.json`
3. **Prebuild**: Run `npm run prebuild:dev` to copy config to android folder
4. **Test**: Verify account selection and silent cancellation work correctly

### Expected User Flow

1. **First Time**: User selects Google account → Auto-registration → Welcome screen
2. **Return User**: User sees account selection → Sign-in → Welcome screen
3. **After Logout**: User sees account selection again (not cached)
4. **Cancellation**: No error message, stays on current screen

### Google Sign-In Benefits

#### Development Benefits

- **Zero additional registration flow** for Google users
- **Seamless OAuth integration** with Firebase
- **Automatic user profile extraction**
- **Consistent authentication state management**

#### User Experience Benefits

- **One-tap sign-in** for Google account holders
- **Account selection** on subsequent logins
- **No password management** required
- **Silent cancellation** without error messages

#### Security Benefits

- **OAuth 2.0 standard** implementation
- **Firebase credential validation**
- **Secure token handling**
- **Proper session management**
